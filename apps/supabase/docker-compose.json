{
  "services": [
    {
      "name": "supabase-kong-init",
      "image": "busybox:latest",
      "command": "sh -c 'mkdir -p /kong && cat > /kong/kong.yml << \"EOF\"\n_format_version: \"2.1\"\nservices:\n  - name: auth-v1\n    url: http://supabase-auth:9999/verify\n    routes:\n      - name: auth-v1-all\n        strip_path: true\n        paths:\n          - /auth/v1/\n    plugins:\n      - name: cors\n  - name: rest-v1\n    url: http://supabase-rest:3000/\n    routes:\n      - name: rest-v1-all\n        strip_path: true\n        paths:\n          - /rest/v1/\n    plugins:\n      - name: cors\n  - name: realtime-v1\n    url: http://supabase-realtime:4000/socket/\n    routes:\n      - name: realtime-v1-all\n        strip_path: true\n        paths:\n          - /realtime/v1/\n    plugins:\n      - name: cors\n  - name: storage-v1\n    url: http://supabase-storage:5000/\n    routes:\n      - name: storage-v1-all\n        strip_path: true\n        paths:\n          - /storage/v1/\n    plugins:\n      - name: cors\n  - name: meta\n    url: http://supabase-meta:8080/\n    routes:\n      - name: meta-all\n        strip_path: true\n        paths:\n          - /pg/\nplugins:\n  - name: cors\n    config:\n      origins:\n        - \"*\"\n      methods:\n        - GET\n        - POST\n        - PUT\n        - PATCH\n        - DELETE\n        - OPTIONS\n      headers:\n        - Accept\n        - Authorization\n        - Content-Type\n        - X-Client-Info\n        - apikey\n        - x-supabase-api-version\n      exposed_headers:\n        - X-Total-Count\n      credentials: true\n      max_age: 3600\nEOF\n'",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/config",
          "containerPath": "/kong",
          "readOnly": false
        }
      ],
      "restart": "on-failure"
    },
    {
      "name": "supabase-studio",
      "image": "supabase/studio:20231123-64e9f5a",
      "isMain": true,
      "internalPort": "3000",
      "environment": {
        "STUDIO_PG_META_URL": "http://supabase-meta:8080",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
        "DEFAULT_ORGANIZATION_NAME": "Supabase",
        "DEFAULT_PROJECT_NAME": "Supabase",
        "SUPABASE_URL": "http://supabase-kong:8000",
        "SUPABASE_PUBLIC_URL": "${SITE_URL}",
        "SUPABASE_ANON_KEY": "${ANON_KEY}",
        "SUPABASE_SERVICE_KEY": "${SERVICE_ROLE_KEY}",
        "AUTH_JWT_SECRET": "${JWT_SECRET}"
      },
      "dependsOn": ["supabase-kong", "supabase-meta"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-kong",
      "image": "kong:2.8.1",
      "internalPort": "8000",
      "environment": {
        "KONG_DATABASE": "off",
        "KONG_DECLARATIVE_CONFIG": "/var/lib/kong/kong.yml",
        "KONG_DNS_ORDER": "LAST,A,CNAME",
        "KONG_PLUGINS": "request-transformer,cors,key-auth,acl,basic-auth",
        "KONG_NGINX_PROXY_PROXY_BUFFER_SIZE": "160k",
        "KONG_NGINX_PROXY_PROXY_BUFFERS": "64 160k"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/config",
          "containerPath": "/var/lib/kong",
          "readOnly": false
        }
      ],
      "dependsOn": ["supabase-kong-init", "supabase-auth", "supabase-rest", "supabase-realtime", "supabase-storage"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-auth",
      "image": "supabase/gotrue:v2.99.0",
      "environment": {
        "GOTRUE_API_HOST": "0.0.0.0",
        "GOTRUE_API_PORT": "9999",
        "API_EXTERNAL_URL": "${SITE_URL}",
        "GOTRUE_DB_DRIVER": "postgres",
        "GOTRUE_DB_DATABASE_URL": "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}",
        "GOTRUE_SITE_URL": "${SITE_URL}",
        "GOTRUE_URI_ALLOW_LIST": "*",
        "GOTRUE_DISABLE_SIGNUP": "false",
        "GOTRUE_JWT_ADMIN_ROLES": "service_role",
        "GOTRUE_JWT_AUD": "authenticated",
        "GOTRUE_JWT_DEFAULT_GROUP_NAME": "authenticated",
        "GOTRUE_JWT_EXP": "3600",
        "GOTRUE_JWT_SECRET": "${JWT_SECRET}",
        "GOTRUE_EXTERNAL_EMAIL_ENABLED": "true",
        "GOTRUE_MAILER_AUTOCONFIRM": "true",
        "GOTRUE_SMTP_HOST": "${SMTP_HOST}",
        "GOTRUE_SMTP_PORT": "${SMTP_PORT}",
        "GOTRUE_SMTP_USER": "${SMTP_USER}",
        "GOTRUE_SMTP_PASS": "${SMTP_PASS}",
        "GOTRUE_SMTP_ADMIN_EMAIL": "${SMTP_SENDER_EMAIL}",
        "GOTRUE_MAILER_URLPATHS_INVITE": "/auth/v1/verify",
        "GOTRUE_MAILER_URLPATHS_CONFIRMATION": "/auth/v1/verify",
        "GOTRUE_MAILER_URLPATHS_RECOVERY": "/auth/v1/verify",
        "GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE": "/auth/v1/verify"
      },
      "dependsOn": ["supabase-db"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-rest",
      "image": "postgrest/postgrest:v12.0.2",
      "environment": {
        "PGRST_DB_URI": "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}",
        "PGRST_DB_SCHEMAS": "public,storage",
        "PGRST_DB_ANON_ROLE": "anon",
        "PGRST_JWT_SECRET": "${JWT_SECRET}",
        "PGRST_DB_USE_LEGACY_GUCS": "false"
      },
      "dependsOn": ["supabase-db"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-realtime",
      "image": "supabase/realtime:v2.25.35",
      "environment": {
        "PORT": "4000",
        "DB_HOST": "supabase-db",
        "DB_PORT": "5432",
        "DB_USER": "${POSTGRES_USER}",
        "DB_PASSWORD": "${POSTGRES_PASSWORD}",
        "DB_NAME": "${POSTGRES_DB}",
        "DB_AFTER_CONNECT_QUERY": "SET search_path TO _realtime",
        "DB_ENC_KEY": "supabaserealtime",
        "API_JWT_SECRET": "${JWT_SECRET}",
        "FLY_ALLOC_ID": "fly123",
        "FLY_APP_NAME": "realtime",
        "SECRET_KEY_BASE": "UpNVntn3cDxHJpq99YMc1T1AQgQpc8kfYTuRgBiYa15BLrx8etQoXz3gZv1/u2oq",
        "ERL_AFLAGS": "-proto_dist inet_tcp",
        "ENABLE_TAILSCALE": "false",
        "DNS_NODES": "''"
      },
      "dependsOn": ["supabase-db"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-storage",
      "image": "supabase/storage-api:v0.43.11",
      "environment": {
        "ANON_KEY": "${ANON_KEY}",
        "SERVICE_KEY": "${SERVICE_ROLE_KEY}",
        "POSTGREST_URL": "http://supabase-rest:3000",
        "PGRST_JWT_SECRET": "${JWT_SECRET}",
        "DATABASE_URL": "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@supabase-db:5432/${POSTGRES_DB}",
        "FILE_SIZE_LIMIT": "52428800",
        "STORAGE_BACKEND": "file",
        "FILE_STORAGE_BACKEND_PATH": "/var/lib/storage",
        "TENANT_ID": "stub",
        "REGION": "stub",
        "GLOBAL_S3_BUCKET": "stub",
        "ENABLE_IMAGE_TRANSFORMATION": "true",
        "IMGPROXY_URL": "http://supabase-imgproxy:5001"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/storage",
          "containerPath": "/var/lib/storage",
          "readOnly": false
        }
      ],
      "dependsOn": ["supabase-db", "supabase-rest", "supabase-imgproxy"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-imgproxy",
      "image": "darthsim/imgproxy:v3.8.0",
      "environment": {
        "IMGPROXY_BIND": ":5001",
        "IMGPROXY_LOCAL_FILESYSTEM_ROOT": "/",
        "IMGPROXY_USE_ETAG": "true",
        "IMGPROXY_ENABLE_WEBP_DETECTION": "true"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/storage",
          "containerPath": "/var/lib/storage",
          "readOnly": true
        }
      ],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-meta",
      "image": "supabase/postgres-meta:v0.68.0",
      "environment": {
        "PG_META_PORT": "8080",
        "PG_META_DB_HOST": "supabase-db",
        "PG_META_DB_PORT": "5432",
        "PG_META_DB_NAME": "${POSTGRES_DB}",
        "PG_META_DB_USER": "${POSTGRES_USER}",
        "PG_META_DB_PASSWORD": "${POSTGRES_PASSWORD}"
      },
      "dependsOn": ["supabase-db"],
      "restart": "unless-stopped"
    },
    {
      "name": "supabase-db",
      "image": "supabase/postgres:15.1.0.147",
      "environment": {
        "POSTGRES_HOST": "/var/run/postgresql",
        "POSTGRES_PORT": "5432",
        "POSTGRES_DB": "${POSTGRES_DB}",
        "POSTGRES_USER": "${POSTGRES_USER}",
        "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
        "JWT_SECRET": "${JWT_SECRET}",
        "JWT_EXP": "3600"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/db",
          "containerPath": "/var/lib/postgresql/data",
          "readOnly": false
        }
      ],
      "healthCheck": {
        "test": "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5
      },
      "restart": "unless-stopped"
    }
  ]
}
